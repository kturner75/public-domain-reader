# Local Database Configuration (H2)
# For production database engines, use profile overrides:
# - PostgreSQL: --spring.profiles.active=prod
# - MariaDB: --spring.profiles.active=mariadb
spring.datasource.url=jdbc:h2:file:./data/library;DB_CLOSE_DELAY=-1
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=

# JPA Configuration (local dev)
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=false

# H2 Console (for debugging)
spring.h2.console.enabled=true
spring.h2.console.path=/h2-console

# Flyway migrations
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
spring.flyway.baseline-on-migrate=true
spring.flyway.baseline-version=1

# TTS Configuration
tts.openai.api-key=${OPENAI_API_KEY:}
tts.openai.model=gpt-4o-mini-tts
tts.openai.default-voice=fable
tts.cache-dir=./data/audio
tts.cache-only=false

# AI Feature Flags
ai.reasoning.enabled=true
# Controls chat APIs (character chat + recap chat). Independent of generation.cache-only.
ai.chat.enabled=true

# Reasoning Provider (character extraction, voice analysis, prompt generation)
ai.reasoning.provider=xai
ai.reasoning.timeout-seconds=180

# Reasoning - Ollama config
ai.reasoning.ollama.base-url=http://localhost:11434
ai.reasoning.ollama.model=llama3.1:latest

# Reasoning - xAI config (for when you want to switch)
ai.reasoning.xai.api-key=${XAI_API_KEY:}
ai.reasoning.xai.model=grok-4-1-fast-reasoning

# Chat Provider (character chat)
ai.chat.provider=ollama
ai.chat.timeout-seconds=60

# Chat - Ollama config (for local testing)
ai.chat.ollama.base-url=http://localhost:11434
ai.chat.ollama.model=llama3.1:latest

# Chat - xAI config
ai.chat.xai.api-key=${XAI_API_KEY:}
ai.chat.xai.model=grok-4-1-fast-non-reasoning

# ComfyUI Configuration
comfyui.base-url=http://127.0.0.1:8188
comfyui.workflow-timeout=120000
comfyui.checkpoint=dreamshaperXL_lightningDPMSDE.safetensors

# Illustration Configuration
illustration.cache-dir=./data/illustrations
illustration.image-width=768
illustration.image-height=1024
illustration.sampler-steps=20
illustration.cfg-scale=8
illustration.allow-prompt-editing=true
# Lease window for illustration generation workers; expired leases can be reclaimed by another worker.
illustration.generation.lease-minutes=20
# Optional stable worker identifier for illustration lease ownership.
illustration.generation.worker-id=${HOSTNAME:}

# Character Feature Configuration
character.enabled=true
character.portrait.width=512
character.portrait.height=640
character.portrait.cache-dir=./data/character-portraits
character.extraction.max-characters-per-chapter=5
character.chat.max-context-messages=10
# Lease windows for character analysis + portrait workers.
character.analysis.lease-minutes=15
character.portrait.lease-minutes=20
# Optional stable worker identifier for character lease ownership.
character.generation.worker-id=${HOSTNAME:}

# Recap Feature Configuration
recap.enabled=true
recap.rollout.mode=all
recap.rollout.allowed-book-ids=
recap.reasoning.provider=${ai.reasoning.provider:ollama}
recap.reasoning.timeout-seconds=${ai.reasoning.timeout-seconds:180}
recap.reasoning.ollama.base-url=${ai.reasoning.ollama.base-url:http://localhost:11434}
recap.reasoning.ollama.model=${ai.reasoning.ollama.model:llama3.1:latest}
recap.reasoning.xai.api-key=${ai.reasoning.xai.api-key:}
recap.reasoning.xai.model=${ai.reasoning.xai.model:grok-4-1-fast-reasoning}
# Lease window for recap workers; when it expires, another worker may claim stale recap jobs.
recap.generation.lease-minutes=20
# Optional stable worker identifier for recap lease ownership (defaults to HOSTNAME when set).
recap.generation.worker-id=${HOSTNAME:}

# Quiz Feature Configuration
quiz.enabled=true
quiz.reasoning.provider=${ai.reasoning.provider:ollama}
quiz.reasoning.timeout-seconds=${ai.reasoning.timeout-seconds:180}
quiz.reasoning.ollama.base-url=${ai.reasoning.ollama.base-url:http://localhost:11434}
quiz.reasoning.ollama.model=${ai.reasoning.ollama.model:llama3.1:latest}
quiz.reasoning.xai.api-key=${ai.reasoning.xai.api-key:}
quiz.reasoning.xai.model=${ai.reasoning.xai.model:grok-4-1-fast-reasoning}
quiz.generation.questions-per-chapter=3
quiz.generation.max-questions=5
quiz.generation.max-context-chars=7000
quiz.difficulty.ramp.enabled=true
quiz.difficulty.ramp.chapter-step=6
quiz.difficulty.ramp.max-level=3
quiz.difficulty.ramp.question-boost-per-level=1

# Speed Reading Feature Configuration
speed-reading.enabled=true

# Classroom Demo Context (BL-018.6)
# Off by default; when enabled, landing page switches to assignment-first classroom variant.
classroom.demo.enabled=false
classroom.demo.class-id=
classroom.demo.class-name=
classroom.demo.teacher-name=
classroom.demo.features.quiz-enabled=true
classroom.demo.features.recap-enabled=true
classroom.demo.features.tts-enabled=true
classroom.demo.features.illustration-enabled=true
classroom.demo.features.character-enabled=true
classroom.demo.features.chat-enabled=true
classroom.demo.features.speed-reading-enabled=true

# Deployment/Security Configuration
# local: no auth gate for generation/chat endpoints.
# public: sensitive generation/chat endpoints require auth (X-API-Key or collaborator session) and apply per-IP rate limits.
deployment.mode=local
security.public.api-key=${PUBLIC_API_KEY:}
security.public.collaborator.password=${PUBLIC_COLLABORATOR_PASSWORD:}
security.public.session.cookie-name=pdr_collab_session
security.public.session.ttl-minutes=480
# Set true when serving over HTTPS so collaborator session cookies are sent only on secure transport.
security.public.session.secure-cookie=false
security.public.rate-limit.window-seconds=60
security.public.rate-limit.generation-requests=30
security.public.rate-limit.chat-requests=45
security.public.rate-limit.authenticated-generation-requests=60
security.public.rate-limit.authenticated-chat-requests=90
# Rate-limit state store: in-memory (single-instance) or database (multi-instance resilient).
security.public.rate-limit.store=in-memory
# Cleanup cadence (request ticks) for stale limiter windows when using database store.
security.public.rate-limit.cleanup-interval=256
security.public.rate-limit.max-keys=20000
# Anonymous reader profile cookie used for per-reader annotations/bookmarks.
reader.profile.cookie-name=pdr_reader_profile

# Reader Account Auth (BL-021)
# Separate from collaborator auth (`/api/auth`) used for public-mode operational access.
account.auth.enabled=true
account.auth.rollout.mode=optional
account.auth.rollout.allowed-emails=
account.auth.cookie-name=pdr_account_session
account.auth.session.ttl-minutes=43200
account.auth.secure-cookie=${security.public.session.secure-cookie:false}
account.auth.password.min-length=10
account.auth.password.bcrypt-strength=12

# Generation Configuration
# When true, artifact generation requests are blocked to avoid paid generation on cache misses.
# Applies to recap/quiz generation and other background generation pipelines.
# Does NOT disable chat APIs; chat is controlled by ai.chat.enabled + chat provider availability.
generation.cache-only=false
# When true, queue-backed generation services requeue persisted pending/stuck work on app startup.
generation.queue.recovery.enabled=true
# Max generation attempts per job (initial attempt + retries).
generation.retry.max-attempts=3
# Base delay before retrying failed generation work.
generation.retry.initial-delay-seconds=30
# Cap on exponential retry backoff delay.
generation.retry.max-delay-seconds=600

# Asset CDN Configuration
assets.cdn-base-url=https://public-domain-reader.atl1.cdn.digitaloceanspaces.com
assets.cdn-prefix=assets

# Pre-generation Configuration
pregen.poll-interval-seconds=10
pregen.max-wait-minutes=120
pregen.stall-threshold-polls=30
pregen.cooldown-minutes=10
recap.generation.stuck-threshold-minutes=15
